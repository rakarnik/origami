#!/usr/bin/perl

use strict;
use Switch;
use POSIX qw(floor);
use Getopt::Long;

sub helpmenu {
  print "origami-conversion <bed/bedpe/washu> <results file> <score column>\n";
}

sub tobed {
  my $c = $_[0];
  
  while(<F>) {
    chomp;
    my @arr = split /,/;
    
    next unless $arr[0] eq $arr[3]; # only print lines with intrachromosomal interactions (since BED is not designed to handle interchromsomal data)
    
    my $val = floor($arr[5+$c]*1000);
    my $size = ($arr[2]-$arr[1]) . ',' . ($arr[5]-$arr[4]);
    my $starts = ($arr[1]-$arr[1]) . ',' . ($arr[4]-$arr[1]);
    
    print "$arr[0]\t$arr[1]\t$arr[5]\tInteraction\t$val\t+\t$arr[1]\t$arr[1]\t0,0,0\t2\t$size\t$starts\n";
  }
}

sub tobedpe {
  my $c = $_[0];
  while(<F>) {
    chomp;
    my @arr = split/,/;
  
    print "$arr[0]\t$arr[1]\t$arr[2]\t$arr[3]\t$arr[4]\t$arr[5]\tInteraction\t$arr[5+$c]\t.\t.\n";
  }
}

sub towashu {
  my $c = $_[0];
  while(<F>) {
    chomp;
    my @arr = split /,/;
  
    next unless $arr[0] eq $arr[3]; # Remove interchromosomal interactions
    next if $arr[0] =~ /chrM/; # the browser doesn't like chrM
  
    print "$arr[0]:$arr[1]-$arr[2]\t$arr[3]:$arr[4]-$arr[5]\t$arr[5+$c]\n";
  }
}

my $showhelp = '';

GetOptions("help|h"=>\$showhelp)
or die "Error in parsing arguments";

if( $showhelp eq 1 ) {
  helpmenu();
  exit 0;
}

if( $#ARGV < 2 ) {
  helpmenu("Not enough arguments passed");
  exit 1;
}



my $option = $ARGV[0];
my $file = $ARGV[1];
my $column = $ARGV[2];

die "$file does not exist" unless -e $file;
die "Score column is not a number" unless $column =~ /\d+/;

open(F,"$file") or die "Cannot open $!";
<F>; # discard header line

switch($option) {
  case "bed"    { tobed($column); }
  case "bedpe"  { tobedpe($column); }
  case "washu"  { towashu($column); }
  else          { print "Invalid option: $option\n"; }
}
close(F);