#!/bin/bash

BASEDIR=$(dirname $0)
SCRIPTDIR=$BASEDIR/../scripts

PEAKCOUNTFILE=raw-counts.out
INTCOUNTFILE=raw-interactions.out
TMPFILE=$RANDOM.peaks.bed
TMPBAMPREFIX=bam$RANDOM.prefix
BURNIN=100
ITERATIONS=50000
PRUNE=5

helpmenu() {
  if [ $# -eq 1 ];
  then
    echo $1
  fi
  
  echo "origami-analysis <mapped reads BAM> <peak BED file> <output prefix>"
  echo "  -h help menu (this output)"
  echo "  --iterations=[positive integer] Sets the number of iterations for running the MCMC estimation (default 50000)"
  echo "  --burn-in=[0 or positive integer] Sets the number of iterations to use as the burn-in period, separate from the --iterations (default 100, 0 means no burn-in period)"
  echo "  --prune=[0 or >=2] Sets the number of steps at which to take an iteration rather than prune it (default 5, 0 means no pruning)"
}



TEMP=`getopt -o h -l iterations:,burn-in:,prune: -n 'origami' -- "$@"`
eval set -- "$TEMP"

while [ $# -ge 1 ]; do
	case "$1" in
		--)
			shift
			break
			;;
		-h)
			helpmenu
			exit 0
			;;
		--iterations)
		  ITERATIONS="$1"
		  shift
		  ;;
		--burn-in)
		  BURNIN="$1"
		  shift
		  ;;
		--prune)
		  PRUNE="$1"
		  shift
		  ;;
	esac
	shift
done

if [ $# -lt 3 ];
then
  helpmenu "Error: did not supply necessary file name arguments"
  exit 1
fi

READSFILE=$1
INPUTFILE=$2
PREFIX=$3

echo "Identifying PET counts in peaks and interactions..."

cut -f 1,2,3 $INPUTFILE | sort -k 1,1 -k 2,2n > $TMPFILE

if [ ! -e "$PREFIX-raw-counts.out" ];
then
  bedtools coverage -counts -abam $READSFILE -b $TMPFILE > $PREFIX-raw-counts.out
fi

if [ ! -e "$PREFIX-raw-int-counts.txt" ];
then
  bedtools pairtobed -bedpe -type both -abam $READSFILE -b $TMPFILE > $PREFIX-raw-interactions.out

  $SCRIPTDIR/estimate-counts.pl $PREFIX-raw-interactions.out > $PREFIX-raw-int-counts.txt
fi

rm $TMPFILE 

echo "Estimating interaction belief..."

Rscript $SCRIPTDIR/estimate-significance.r $PREFIX-raw-counts.out $PREFIX-raw-int-counts.txt $PREFIX-results.csv $PREFIX-model-data.Rdata $ITERATIONS $BURNIN $PRUNE