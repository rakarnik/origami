#!/bin/bash

BASEDIR=$(dirname $0)
SCRIPTDIR=$BASEDIR/../scripts

PEAKCOUNTFILE=raw-counts.out
INTCOUNTFILE=raw-interactions.out
TMPFILE=$RANDOM.peaks.bed
TMPBAMFILE=$RANDOM.bam
TMPBAMPREFIX=bam$RANDOM.prefix

INPUTFILE=$1


echo "Identifying PET counts in peaks and interactions..."

cut -f 1,2,3 $INPUTFILE | sort -k 1,1 -k 2,2n > $TMPFILE


## workaround -- bedtools intersect with -sorted won't take BAM with unmapped reads
samtools sort -Obam -T$TMPBAMPREFIX mapped_reads.bam > $TMPBAMFILE
samtools view -hb -F 0x4 $TMPBAMFILE |  bedtools intersect -c -sorted -a $TMPFILE -b - > $2-raw-counts.out

rm $TMPBAMFILE

bedtools pairtobed -bedpe -type both -abam mapped_reads.bam -b $TMPFILE > $2-raw-interactions.out

$SCRIPTDIR/estimate-counts.pl $2-raw-interactions.out > $2-raw-int-counts.txt

rm $TMPFILE 

#Rscript $SCRIPTDIR/estimate-interaction-counts.r 

echo "Estimating interaction belief..."

Rscript $SCRIPTDIR/estimate-significance.r $2-raw-counts.out $2-raw-int-counts.txt $2-results.csv $2-model-data.Rdata