#!/bin/bash

BASEDIR=$(dirname $0)
SCRIPTDIR=$BASEDIR/../scripts

PEAKCOUNTFILE=raw-counts.out
INTCOUNTFILE=raw-interactions.out
TMPFILE=$RANDOM.peaks.bed
TMPBAMPREFIX=bam$RANDOM.prefix

READSFILE=$1
INPUTFILE=$2
PREFIX=$3


echo "Identifying PET counts in peaks and interactions..."

cut -f 1,2,3 $INPUTFILE | sort -k 1,1 -k 2,2n > $TMPFILE

bedtools coverage -counts -abam $READSFILE -b $TMPFILE > $PREFIX-raw-counts.out


bedtools pairtobed -bedpe -type both -abam $READSFILE -b $TMPFILE > $PREFIX-raw-interactions.out

$SCRIPTDIR/estimate-counts.pl $PREFIX-raw-interactions.out > $PREFIX-raw-int-counts.txt

rm $TMPFILE 

echo "Estimating interaction belief..."

Rscript $SCRIPTDIR/estimate-significance.r $PREFIX-raw-counts.out $PREFIX-raw-int-counts.txt $PREFIX-results.csv $PREFIX-model-data.Rdata